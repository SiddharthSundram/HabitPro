{% extends "base.html" %}
{% block content %}

<div class="max-w-4xl mx-auto animate-fade-in">
    
    <div class="bg-white dark:bg-dark-card rounded-3xl shadow-sm hover:shadow-xl transition-all duration-300 p-8 border-t-4 {{ color_class }} relative overflow-hidden group mb-8 border border-gray-100 dark:border-dark-border">
        
        <div class="flex justify-between items-start relative z-10">
            <div>
                <a href="{{ url_for('main.dashboard') }}" class="text-gray-400 dark:text-gray-500 hover:text-indigo-600 dark:hover:text-indigo-400 mb-4 inline-flex items-center transition text-sm font-bold">
                    <i class="fas fa-arrow-left mr-2"></i> Dashboard
                </a>
                
                <div class="flex items-center gap-4 mb-2">
                    <h1 class="text-4xl font-extrabold text-gray-900 dark:text-white tracking-tight">{{ habit.name }}</h1>
                    <a href="{{ url_for('main.edit_habit', habit_id=habit.id) }}" class="text-gray-300 hover:text-indigo-500 dark:text-gray-600 dark:hover:text-indigo-400 text-xl transition bg-gray-50 dark:bg-gray-800 p-2 rounded-lg" title="Edit Settings">
                        <i class="fas fa-cog"></i>
                    </a>
                </div>
                
                <span class="inline-flex items-center px-3 py-1 rounded-lg text-xs font-bold uppercase tracking-wider bg-gray-100 dark:bg-gray-800 text-gray-500 dark:text-gray-400">
                    {{ habit.category }}
                </span>
            </div>

            <div class="text-right bg-gray-50 dark:bg-gray-800/50 px-6 py-4 rounded-2xl border border-gray-100 dark:border-gray-700">
                <div class="text-xs text-gray-400 uppercase font-bold tracking-widest mb-1">Current Streak</div>
                <div class="text-5xl font-black text-orange-500 drop-shadow-sm">ðŸ”¥ {{ habit.current_streak }}</div>
                <div class="text-xs text-gray-400 font-medium mt-1">Best: <span class="text-gray-600 dark:text-gray-300">{{ habit.best_streak }}</span></div>
            </div>
        </div>
    </div>

    <div class="bg-white dark:bg-dark-card p-8 rounded-3xl shadow-sm mb-8 border border-gray-100 dark:border-dark-border">
        <div class="flex justify-between items-center mb-8">
            <h2 class="text-2xl font-bold text-gray-800 dark:text-white flex items-center">
                <i class="far fa-calendar-alt mr-3 text-indigo-500"></i>
                {{ month_name }} {{ year }} History
            </h2>
            <div class="flex gap-4 text-xs font-bold text-gray-500 dark:text-gray-400">
                <div class="flex items-center"><div class="w-3 h-3 bg-green-500 rounded-full mr-2"></div> Done</div>
                <div class="flex items-center"><div class="w-3 h-3 bg-yellow-400 rounded-full mr-2"></div> Partial</div>
            </div>
        </div>
        
        <div class="grid grid-cols-7 gap-3 text-center mb-4">
            {% for day in ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'] %}
                <div class="text-xs font-bold text-gray-400 uppercase tracking-widest">{{ day }}</div>
            {% endfor %}
        </div>

        <div class="grid grid-cols-7 gap-3">
            {% for week in cal %}
                {% for day in week %}
                    {% if day == 0 %}
                        <div class="h-20 bg-transparent"></div>
                    {% else %}
                        {% set log = log_map.get(day) %}
                        {% set is_done = log and log.value >= habit.target_value %}
                        {% set is_partial = log and log.value > 0 and not is_done %}
                        
                        <div class="h-20 rounded-2xl border flex flex-col items-center justify-center relative group transition-all duration-300 cursor-default
                            {% if is_done %} bg-green-500 text-white border-green-600 shadow-md shadow-green-200 dark:shadow-none
                            {% elif is_partial %} bg-yellow-50 dark:bg-yellow-900/20 text-yellow-700 dark:text-yellow-400 border-yellow-200 dark:border-yellow-700
                            {% elif day == today.day %} border-indigo-500 border-2 bg-white dark:bg-dark-card dark:text-white
                            {% else %} bg-gray-50 dark:bg-gray-800/50 text-gray-300 dark:text-gray-600 border-gray-100 dark:border-gray-800 {% endif %}">
                            
                            <span class="font-bold text-lg">{{ day }}</span>
                            {% if is_done %}<div class="text-sm opacity-90 mt-1"><i class="fas fa-check"></i></div>{% endif %}
                            
                            {% if log and log.note %}
                                <div class="absolute top-2 right-2 w-2 h-2 bg-white rounded-full shadow-sm animate-pulse {% if not is_done %}bg-indigo-400{% endif %}"></div>
                                <div class="absolute bottom-full mb-3 hidden group-hover:block w-48 bg-gray-900 text-white text-xs p-3 rounded-xl shadow-xl z-20 text-center backdrop-blur-md">
                                    <p class="italic mb-2">"{{ log.note }}"</p>
                                    <div class="text-gray-400 border-t border-gray-700 pt-1 font-bold">
                                        Value: {{ log.value }} {{ habit.unit if habit.unit }}
                                    </div>
                                    <div class="absolute top-full left-1/2 transform -translate-x-1/2 border-4 border-transparent border-t-gray-900"></div>
                                </div>
                            {% endif %}
                        </div>
                    {% endif %}
                {% endfor %}
            {% endfor %}
        </div>
    </div>

    <div class="bg-white dark:bg-dark-card p-8 rounded-3xl shadow-sm mb-8 border border-gray-100 dark:border-dark-border">
        <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-6 flex items-center">
            <i class="fas fa-chart-line mr-3 text-indigo-500"></i>
            30-Day Trend
        </h2>
        <div class="relative h-72 w-full">
            <canvas id="trendChart"></canvas>
        </div>
    </div>

    <div class="bg-white dark:bg-dark-card p-8 rounded-3xl shadow-sm border border-gray-100 dark:border-dark-border">
        <h2 class="text-2xl font-bold mb-6 text-gray-800 dark:text-white flex items-center">
            <i class="fas fa-book-open mr-3 text-indigo-500"></i>
            Journal & Notes
        </h2>
        
        <div class="space-y-4">
            {% set has_notes = false %}
            {% for day, log in log_map.items()|sort(reverse=True) %}
                {% if log.note %}
                {% set has_notes = true %}
                <div class="flex items-start p-5 bg-gray-50 dark:bg-gray-800/50 rounded-2xl hover:bg-indigo-50 dark:hover:bg-gray-800 transition border border-gray-100 dark:border-gray-700/50">
                    <div class="bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 text-indigo-600 dark:text-indigo-400 font-bold p-3 rounded-xl mr-5 text-center min-w-[70px] shadow-sm">
                        <div class="text-xs uppercase text-gray-400">{{ month_name[:3] }}</div>
                        <div class="text-2xl">{{ day }}</div>
                    </div>
                    <div>
                        <p class="text-gray-800 dark:text-gray-200 italic text-lg leading-relaxed">"{{ log.note }}"</p>
                        <div class="text-xs text-gray-400 mt-2 font-bold uppercase tracking-wider flex items-center gap-2">
                            <span class="bg-indigo-100 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400 px-2 py-0.5 rounded">
                                {{ log.value }} {{ habit.unit if habit.unit }}
                            </span>
                        </div>
                    </div>
                </div>
                {% endif %}
            {% endfor %}

            {% if not has_notes %}
                <div class="text-center py-12 text-gray-400 dark:text-gray-500">
                    <i class="far fa-sticky-note text-5xl mb-4 opacity-30"></i>
                    <p>No notes recorded yet.</p>
                </div>
            {% endif %}
        </div>
    </div>

</div>

<script>
    const ctx = document.getElementById('trendChart').getContext('2d');
    const isDark = document.documentElement.classList.contains('dark');
    
    const gradient = ctx.createLinearGradient(0, 0, 0, 400);
    gradient.addColorStop(0, isDark ? 'rgba(99, 102, 241, 0.5)' : 'rgba(79, 70, 229, 0.4)');
    gradient.addColorStop(1, isDark ? 'rgba(99, 102, 241, 0)' : 'rgba(79, 70, 229, 0)');

    new Chart(ctx, {
        type: 'line',
        data: {
            labels: {{ chart_labels | tojson }},
            datasets: [{
                label: '{{ habit.name }} Progress',
                data: {{ chart_data | tojson }},
                borderColor: '#6366f1',
                backgroundColor: gradient,
                borderWidth: 3,
                pointBackgroundColor: isDark ? '#1e293b' : '#fff',
                pointBorderColor: '#6366f1',
                pointBorderWidth: 3,
                pointRadius: 5,
                pointHoverRadius: 7,
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    backgroundColor: isDark ? '#1e293b' : '#111827',
                    padding: 12,
                    cornerRadius: 12,
                    displayColors: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: { borderDash: [5, 5], color: isDark ? '#334155' : '#f3f4f6' },
                    ticks: { color: isDark ? '#94a3b8' : '#6b7280' }
                },
                x: {
                    grid: { display: false },
                    ticks: { color: isDark ? '#94a3b8' : '#6b7280' }
                }
            }
        }
    });
</script>

{% endblock %}